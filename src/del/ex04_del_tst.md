# Exercise 04 — State table (Таблица состояний)

Задача: 2 — Delivery of orders (prefix: `del`)

## Объекты с жизненным циклом

- `Order` (Заказ)
- `OrderAssignment` (Назначение/бронь)
- `Notification` (Уведомление)

Ниже таблицы состояний для области `to be` (после внедрения онлайн‑платформы и мобильного приложения).

---

## 1) Объект: Заказ (`Order`)

### Цель

Зафиксировать жизненный цикл заказа доставки и ключевые события, меняющие состояние.

### Область рассмотрения

`to be`

### Таблица состояний

| Предыдущее состояние | Следующее состояние | Событие (действие) | Инициатор | Условия/ветвления |
|---|---|---|---|---|
| **START** | `created` | Зарегистрировать заказ | Оператор/Система | Заказ создан в системе на основе данных поставщика |
| `created` | `accepted` | Принять заказ к обработке | Система | Валидация пройдена; обязательные поля заполнены |
| `created` | `cancelled` | Отменить заказ | Оператор/Диспетчер/Поставщик | До начала доставки; фиксируется причина |
| `accepted` | `assigned` | Выставить в пул / назначить | Система/Диспетчер | Доступен для брони курьерами **или** назначен диспетчером |
| `assigned` | `picked_up` | Зафиксировать получение у поставщика | Курьер | Курьер подтвердил “забрал” (статус из мобильного приложения) |
| `picked_up` | `in_transit` | Зафиксировать выезд к клиенту | Курьер | Переход после получения; может быть сразу после `picked_up` |
| `in_transit` | `delivered` | Подтвердить доставку | Клиент/Курьер | POD подтверждён (код/фото/подпись) |
| `assigned` | `failed` | Зафиксировать срыв доставки | Курьер/Диспетчер | Причина: клиент недоступен/адрес/повреждение/форс‑мажор |
| `picked_up` | `failed` | Зафиксировать срыв после получения | Курьер/Диспетчер | Требует обработку возврата/повторной доставки **[УТОЧНИТЬ]** политика |
| `failed` | `assigned` | Переназначить/повторить доставку | Диспетчер | Если допускается повторная попытка; иначе остаётся `failed` |
| `cancelled` | **END** | Завершить жизненный цикл | Система | Закрыть/архивировать |
| `delivered` | **END** | Завершить жизненный цикл | Система | Закрыть/архивировать |
| `failed` | **END** | Завершить жизненный цикл | Система | После обработки и фиксации итогового статуса |

---

## 2) Объект: Назначение/бронь (`OrderAssignment`)

### Цель

Описать жизненный цикл назначения заказа курьеру и условия переназначений.

### Область рассмотрения

`to be`

### Таблица состояний

| Предыдущее состояние | Следующее состояние | Событие (действие) | Инициатор | Условия/ветвления |
|---|---|---|---|---|
| **START** | `assigned` | Создать назначение | Система/Диспетчер | Заказ выставлен в пул или назначен конкретному курьеру |
| `assigned` | `accepted` | Принять назначение | Курьер | Курьер нажал “взять”; бронь атомарна |
| `assigned` | `rejected` | Отклонить назначение | Курьер | Курьер отказался/истёк таймаут принятия |
| `accepted` | `cancelled` | Снять назначение | Диспетчер/Система | Переназначение, блокировка курьера, SLA/инцидент |
| `accepted` | `completed` | Завершить назначение | Система | Заказ доставлен (`Order.delivered`) |
| `rejected` | **END** | Завершить | Система | Назначение закрыто, заказ остаётся доступным |
| `cancelled` | **END** | Завершить | Система | Назначение закрыто, создаётся новое назначение при необходимости |
| `completed` | **END** | Завершить | Система | Назначение закрыто |

---

## 3) Объект: Уведомление (`Notification`)

### Цель

Описать жизненный цикл уведомлений клиенту/курьеру о статусе заказа и ETA.

### Область рассмотрения

`to be`

### Таблица состояний

| Предыдущее состояние | Следующее состояние | Событие (действие) | Инициатор | Условия/ветвления |
|---|---|---|---|---|
| **START** | `planned` | Запланировать уведомление | Система | Триггер: смена статуса заказа/ETA/инцидент |
| `planned` | `sent` | Отправить уведомление | Система | Канал доступен; сформировано сообщение |
| `sent` | `delivered` | Подтвердить доставку | Сервис уведомлений | Callback/webhook “delivered” |
| `sent` | `failed` | Зафиксировать ошибку | Сервис уведомлений/Система | Callback “failed” или таймаут |
| `failed` | `planned` | Повторить отправку | Система | Разрешены ретраи; лимит попыток не исчерпан |
| `delivered` | **END** | Завершить | Система | Доставка подтверждена |
| `failed` | **END** | Завершить | Система | Ретраи исчерпаны или уведомление не актуально |

