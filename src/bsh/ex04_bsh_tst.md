# Exercise 04 — State table (Таблица состояний)

Задача: 1 — Sign up for a haircut (prefix: `bsh`)

## Объекты с жизненным циклом

- `Appointment` (Запись)
- `ScheduleSlot` (Слот расписания)
- `Notification` (Уведомление)

Ниже таблицы состояний для области `to be` (после внедрения системы).

---

## 1) Объект: Запись (`Appointment`)

### Цель

Зафиксировать жизненный цикл записи на услугу и условия переходов между состояниями.

### Область рассмотрения

`to be`

### Таблица состояний

| Предыдущее состояние | Следующее состояние | Событие (действие) | Инициатор | Условия/ветвления |
|---|---|---|---|---|
| **START** | `created` | Создать запись | Клиент/Гость | Слот свободен; данные обязательных полей заполнены |
| `created` | `confirmed` | Подтвердить запись | Система/Менеджер | Авто‑подтверждение включено **или** менеджер подтвердил вручную |
| `created` | `cancelled` | Отменить запись | Клиент/Гость/Менеджер | До подтверждения (или по правилам), причина отмены фиксируется |
| `confirmed` | `rescheduled` | Перенести запись | Клиент/Гость/Менеджер | Новый слот свободен; перенос разрешён (cut‑off не нарушен) |
| `rescheduled` | `confirmed` | Подтвердить перенос | Система/Менеджер | Авто‑подтверждение переноса **или** ручное подтверждение |
| `confirmed` | `cancelled` | Отменить запись | Клиент/Гость/Менеджер | Разрешено правилами (cut‑off/штрафы); фиксируется причина |
| `confirmed` | `done` | Отметить выполнение услуги | Менеджер | Факт оказания услуги подтверждён (после визита) |
| `confirmed` | `no_show` | Зафиксировать неявку | Система/Менеджер | Клиент не явился до времени + допуск; политика no‑show |
| `cancelled` | **END** | Завершить жизненный цикл | Система | Запись архивируется/закрывается для изменений |
| `done` | **END** | Завершить жизненный цикл | Система | Запись закрыта; далее возможно только чтение/аналитика |
| `no_show` | **END** | Завершить жизненный цикл | Система | Запись закрыта; возможны штрафы/заметки по политике |

---

## 2) Объект: Слот расписания (`ScheduleSlot`)

### Цель

Зафиксировать жизненный цикл слота мастера (доступность/бронирование/блокировка).

### Область рассмотрения

`to be`

### Таблица состояний

| Предыдущее состояние | Следующее состояние | Событие (действие) | Инициатор | Условия/ветвления |
|---|---|---|---|---|
| **START** | `free` | Создать слот | Менеджер/Система | Слот попадает в расписание мастера |
| `free` | `booked` | Забронировать слот | Система | Создана запись `Appointment` и подтверждена (или создана в `created` — **[УТОЧНИТЬ]** политика блокировки) |
| `free` | `blocked` | Заблокировать слот | Менеджер/Система | Перерыв/отпуск/санитария; фиксируется причина |
| `blocked` | `free` | Снять блокировку | Менеджер | Блокировка больше не актуальна |
| `booked` | `free` | Освободить слот | Система/Менеджер | Запись отменена/перенесена до начала визита |
| `free` | **END** | Архивировать слот | Система | По окончании периода (исторические данные) |
| `booked` | **END** | Архивировать слот | Система | После завершения визита/неявки |
| `blocked` | **END** | Архивировать слот | Система | По окончании периода блокировки (история) |

---

## 3) Объект: Уведомление (`Notification`)

### Цель

Зафиксировать жизненный цикл отправки уведомления и получение статуса доставки от провайдера.

### Область рассмотрения

`to be`

### Таблица состояний

| Предыдущее состояние | Следующее состояние | Событие (действие) | Инициатор | Условия/ветвления |
|---|---|---|---|---|
| **START** | `planned` | Запланировать уведомление | Система | Триггер: создание/перенос/отмена записи или напоминание по расписанию |
| `planned` | `sent` | Отправить уведомление | Система | Наступило `sendAt`; канал доступен |
| `sent` | `delivered` | Подтвердить доставку | Сервис уведомлений | Callback/webhook “delivered” |
| `sent` | `failed` | Зафиксировать ошибку доставки | Сервис уведомлений/Система | Callback “failed” или таймаут ожидания |
| `failed` | `planned` | Повторить отправку | Система | Есть ретраи; не превышен лимит попыток |
| `delivered` | **END** | Завершить | Система | Доставка подтверждена |
| `failed` | **END** | Завершить | Система | Ретраи исчерпаны или событие больше не актуально |

